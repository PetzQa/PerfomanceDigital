on: [push]

jobs:
  jmeter_job:
    runs-on: ubuntu-latest
    name: JMeter Test Execution
    steps:
      # Checkout do repositório
      - name: Checkout
        uses: actions/checkout@v3

      # Instalação do JMeter
      - name: Install JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y jmeter

      # Execução dos testes JMeter
      - name: Run JMeter Tests
        run: |
          for test_file in ./PerformanceDigital/**/*.jmx; do
            echo "Running JMeter test: $test_file"
            # Gera os arquivos .jtl e os relatórios HTML automaticamente
            jmeter -n -t "$test_file" -l ./PerformanceDigital/reports/jtl/"$(basename "$test_file" .jmx)".jtl -e -o ./PerformanceDigital/reports/html/"$(basename "$test_file" .jmx)"
          done

      # Upload dos arquivos .jtl gerados
      - name: Upload JTL Results
        uses: actions/upload-artifact@v3
        with:
          name: jmeter-results
          path: PerformanceDigital/reports/jtl/**/*.jtl  # Captura todos os arquivos .jtl gerados
          if-no-files-found: error  # Lança erro se nenhum arquivo .jtl for encontrado

      # Upload dos relatórios HTML gerados
      - name: Upload HTML Reports
        uses: actions/upload-artifact@v3
        with:
          name: jmeter-reports
          path: PerformanceDigital/reports/html/**/*  # Captura todos os relatórios HTML gerados
          if-no-files-found: error  # Lança erro se nenhum relatório HTML for encontrado
